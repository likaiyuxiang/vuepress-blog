---
title: ES
date: 2022-08-23
sidebar: 'auto'
categories:
 - frontEnd
tags:
 - 数据库
 - es
---

# ES数据库

## 搜索的术语

在我们使用搜索的时候，经常有一些业界术语，通过这些专业术语大家可以快速达到交流的目的，减少沟通的障碍，特将这些术语描述如下，搜索的各个术语其实也可以与数据库的一些概念进行对标。

我们以一个检索全国所有的商户的作为背景，此时我们需要把全国所有的商户做成一个索引(等价于数据库中的一个商户表)，每一个商户都有共同的字段（列），例如商户名，城市名等。

| 术语                 | 描述                                                         | 用法                                                         | 数据库对比概念                                               |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
|                      |                                                              |                                                              |                                                              |
| 字段(Field)          | 用于表述每一个列的名字，字段是文档的组成单元，包含字段名称、字段属性和字段内容 | 例如商户名，城市名就分别是一个字段                           | 列                                                           |
| 字段属性(Attributes) | 描述字段的属性，例如城市名的属性是一个字符串类型，不需要分词等 | 用来描述字段的，包括是否建倒排、正排、分词、值的类型(数字类型、字符串类型等) | 类似字段的Varchar(16),int(20),是否index，primary_index等     |
| 文档(document)       | 文档是可搜索的结构化数据单元，用于描述一整条记录，由多个字段组成 | 例如上海天山西路的KFC商户我们可以作为一个文档                | 记录行                                                       |
| 索引(index)          | 用于描述多个行记录的集合                                     | 例如把所有的商户放在一个索引里                               | 表                                                           |
| 正排                 | 文档到字段对应关系组成的链表，勾选可过滤后会构建正排链表。doc1->id,type,create_time… | 设置docvalues=true                                           | 行记录                                                       |
| 倒排                 | 词组到文档的对应关系组成的链表，勾选可搜索后会构建倒排链表。term1->doc1,doc2,doc3；term2->doc1,doc2 | 设置index=true，如果为false，对应的字段域将不能进行检索(即执行各种Query后返回的结果为空，或者直接报错) | 类似B+树索引Mysql不设置索引还是可以进行查询，但是ES不设置，查询结果为空 |
| 召回                 | 通过用户查询的关键词进行分词，将分词后的词组通过查找倒排链表快速定位到文档，这个过程称为召回。 |                                                              | 查询过程                                                     |
| 召回量               | 召回得到的文档数为召回量，即totalhits                        |                                                              | 查询返回的结果数                                             |
| 分片(Shard)          | 一个索引由多个分片组成，这些分片是索引里面的一部分，每一个分片都具备索引相同的数据结构 | 一个索引分成N个shard，每一个Shard的内容就是这个完整索内容的1/N | 在数据库里没有类似的概念                                     |
| 段(Segment)          | 分片的组成单元，即多个段构成一个分片，段是检索的基本单元，所有的查询/更新都是基于段来查询的， |                                                              |                                                              |
| 段合并               | Lucene的删除是标记删除，更新是先删后增，随着数据不断的更新，一个分片中会累积很多段(这些段里存在很多已经删掉的文档)，段太多会导致查询性能变慢，因此我们需要一个段合并的过程，将那些没有用的数据清除，减少段的个数 |                                                              |                                                              |

### 基本概念

- 集群（cluster）

  ES集群由若干节点组成，这些节点在同一个网络内，cluster-name相同

- 节点（node）

  一个ES的实例，本质上是一个java进程，生产环境一般建议一台机器上运行一个ES实例

  节点有如下分类：

  1、master节点：集群中的一个节点会被选为master节点，它将负责管理集群范畴的变更，例如创建或删除索引，添加节点到集群或从集群删除节点。master节点无需参与文档层面的变更和搜索，这意味着仅有一个master节点并不会因流量增长而成为瓶颈。任意一个节点都可以成为 master 节点。

  2、data节点：持有数据和倒排索引。默认情况下，每个节点都可以通过设定配置文件中的node.data属性为true(默认)成为数据节点。如果需要一个专门的主节点，应将其node.data属性设置为false。

  3、client节点：如果将node.master属性和node.data属性都设置为false，那么该节点就是一个客户端节点，扮演一个负载均衡的角色，将到来的请求路由到集群中的各个节点。

- 索引（index）

  文档的容器，一类文档的集合

- 分片（shard）

  单个节点由于物理机硬件限制，存储的文档是有限的，如果一个索引包含海量文档，则不能在单个节点存储。ES提供分片机制，同一个索引可以存储在不同分片（数据容器）中，这些分片又可以存储在集群中不同节点上。

  分片分为主分片(primary shard) 以及从分片(replica shard) 

  1、主分片与从分片关系：从分片只是主分片的一个副本，它用于提供数据的冗余副本 

  2、从分片应用：在硬件故障时提供数据保护，同时服务于搜索和检索这种只读请求 

  3、是否可变：索引中的主分片的数量在索引创建后就固定下来了，但是从分片的数量可以随时改变 

- 文档（document）

  可搜索的最小单元 ，json格式保存
